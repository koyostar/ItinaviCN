generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum LocationCategory {
  Place
  Restaurant
  Accommodation
  Transport
  Shop
  Other
}

enum ItineraryItemType {
  Flight
  Transport
  Accommodation
  Place
  Food
}

enum ItineraryStatus {
  Planned
  Booked
  Done
  Skipped
}

enum ExpenseCategory {
  Accommodation
  Transport
  Food
  Shop
  Attraction
  Other
}

enum ExchangeRateSource {
  Manual
  Provider
}

enum TripRole {
  OWNER
  EDITOR
  VIEWER
}

enum PaymentMethod {
  Cash
  Card
  App
}

enum UserType {
  Dev
  User
}

enum ExpenseImageType {
  Receipt
  Item
  Other
}

model User {
  id            String   @id @default(uuid())
  username      String   @unique
  email         String?  @unique  // Optional - kept for password recovery
  passwordHash  String
  displayName   String?
  avatar        String?
  userType      UserType @default(User)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  ownedTrips    Trip[]   @relation("TripOwner")
  tripMembers   TripMember[]
  paidExpenses  Expense[] @relation("ExpensePaidBy")
  expenseSplits ExpenseSplit[]
  
  @@index([email])
  @@index([username])
}

model TripMember {
  id        String   @id @default(uuid())
  tripId    String
  userId    String
  role      TripRole @default(EDITOR)
  joinedAt  DateTime @default(now())
  
  trip      Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([tripId, userId])
  @@index([tripId])
  @@index([userId])
}

model Trip {
  id                  String              @id @default(uuid())
  title               String
  destinations        Json?
  startDate           DateTime
  endDate             DateTime

  destinationCurrency String              @default("CNY")
  originCurrency      String              @default("SGD")
  notes               String?
  
  ownerId             String
  owner               User                @relation("TripOwner", fields: [ownerId], references: [id])
  members             TripMember[]
  isShared            Boolean             @default(false)

  locations           Location[]
  itineraryItems      ItineraryItem[]
  exchangeRates       ExchangeRate[]
  expenses            Expense[]

  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  
  @@index([ownerId])
}

model Location {
  id           String           @id @default(uuid())
  tripId       String
  trip         Trip             @relation(fields: [tripId], references: [id], onDelete: Cascade)

  name         String
  category     LocationCategory
  city         String?
  district     String?
  province     String?
  address      String?
  latitude     Decimal?
  longitude    Decimal?
  adcode       String?
  citycode     String?
  amapPoiId    String?
  notes        String?
  
  createdBy    String?
  updatedBy    String?

  itineraryItems ItineraryItem[]
  expenses       Expense[]

  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@index([tripId])
  @@index([createdBy])
}

model ItineraryItem {
  id            String          @id @default(uuid())
  tripId        String
  trip          Trip            @relation(fields: [tripId], references: [id], onDelete: Cascade)

  type          ItineraryItemType
  title         String
  startDateTime DateTime
  endDateTime   DateTime?
  timezone      String          @default("Asia/Shanghai")
  startTimezone String?
  endTimezone   String?
  status        ItineraryStatus @default(Planned)

  locationId    String?
  location      Location?       @relation(fields: [locationId], references: [id], onDelete: SetNull)

  bookingRef    String?
  url           String?
  notes         String?
  details       Json?
  
  createdBy     String?
  updatedBy     String?

  expenses      Expense[]

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([tripId])
  @@index([locationId])
  @@index([createdBy])
}

model ExchangeRate {
  id            String            @id @default(uuid())
  tripId        String
  trip          Trip              @relation(fields: [tripId], references: [id], onDelete: Cascade)

  baseCurrency  String            @default("CNY")
  quoteCurrency String            @default("SGD")
  rate          Decimal
  rateDate      DateTime
  source        ExchangeRateSource @default(Manual)

  createdAt     DateTime          @default(now())

  @@unique([tripId, rateDate])
  @@index([tripId])
}

model Expense {
  id                    String          @id @default(uuid())
  tripId                String
  trip                  Trip            @relation(fields: [tripId], references: [id], onDelete: Cascade)

  title                 String
  category              ExpenseCategory
  expenseDateTime       DateTime

  amountDestinationMinor Int
  destinationCurrency   String

  exchangeRateUsed      Decimal?

  linkedItineraryItemId String?
  linkedItineraryItem   ItineraryItem?  @relation(fields: [linkedItineraryItemId], references: [id], onDelete: SetNull)

  linkedLocationId      String?
  linkedLocation        Location?       @relation(fields: [linkedLocationId], references: [id], onDelete: SetNull)

  notes                 String?
  
  paidByUserId          String?
  paidByUser            User?           @relation("ExpensePaidBy", fields: [paidByUserId], references: [id])
  paymentMethod         PaymentMethod?  @default(Cash)
  
  splits                ExpenseSplit[]
  images                ExpenseImage[]

  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  @@index([tripId])
  @@index([linkedItineraryItemId])
  @@index([linkedLocationId])
  @@index([paidByUserId])
}

model ExpenseSplit {
  id              String    @id @default(uuid())
  expenseId       String
  userId          String
  
  // Amount this user owes for this expense (in destination currency minor units)
  amountOwed      Int
  
  // Settlement tracking
  isSettled       Boolean   @default(false)
  settledAt       DateTime?
  
  expense         Expense   @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@unique([expenseId, userId])
  @@index([expenseId])
  @@index([userId])
}

model ExpenseImage {
  id           String           @id @default(uuid())
  expenseId    String
  filename     String
  originalName String
  mimeType     String
  size         Int              // bytes
  url          String           // S3/R2 URL or local path
  type         ExpenseImageType @default(Receipt)
  description  String?          // Optional additional description
  uploadedAt   DateTime         @default(now())
  uploadedBy   String?          // userId
  
  expense      Expense  @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  
  createdAt    DateTime @default(now())
  
  @@index([expenseId])
}
